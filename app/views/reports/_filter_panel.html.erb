<style>
.filter-rows {
  display: flex !important;
  flex-direction: column !important;
  gap: 20px !important;
}

.filter-row {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 30px !important;
}

.filter-field {
  display: flex !important;
  flex-direction: column !important;
}

@media (max-width: 768px) {
  .filter-row {
    grid-template-columns: 1fr !important;
    gap: 15px !important;
  }
}
</style>

<div id="redmine-issue-summary-filter-panel" class="filter-panel">
  <h3><%= l(:label_redmine_issue_summary_filter, :scope => [:redmine_issue_summary_filter]) %></h3>
  
  <%= form_tag(project_issues_report_path(project), method: :get, id: 'redmine-issue-filter-form') do %>
    <div class="filter-container">
      <div class="filter-rows">
        <div class="filter-row">
          <div class="filter-field">
            <%= label_tag 'filter[status_id][]', l(:field_status) %>
            <%= select_tag 'filter[status_id][]', 
                options_for_select([['ã™ã¹ã¦', '']] + project.rolled_up_statuses.sorted.map { |status| [status.name, status.id] }, 
                params[:filter] && params[:filter][:status_id] ? params[:filter][:status_id] : []),
                { multiple: true, class: 'filter-select filter-multi-select' } %>
          </div>
          
          <div class="filter-field">
            <%= label_tag 'filter[priority_id][]', l(:field_priority) %>
            <%= select_tag 'filter[priority_id][]', 
                options_for_select([['ã™ã¹ã¦', '']] + IssuePriority.active.map { |priority| [priority.name, priority.id] }, 
                params[:filter] && params[:filter][:priority_id] ? params[:filter][:priority_id] : []),
                { multiple: true, class: 'filter-select filter-multi-select' } %>
          </div>
        </div>
        
        <div class="filter-row">
          <div class="filter-field">
            <%= label_tag 'filter[assigned_to_id][]', l(:field_assigned_to) %>
            <%= select_tag 'filter[assigned_to_id][]', 
                options_for_select([['ã™ã¹ã¦', '']] + project.assignable_users.map { |user| [user.name, user.id] }, 
                params[:filter] && params[:filter][:assigned_to_id] ? params[:filter][:assigned_to_id] : []),
                { multiple: true, class: 'filter-select filter-multi-select' } %>
          </div>
          
          <div class="filter-field">
            <%= label_tag 'filter[tracker_id][]', l(:field_tracker) %>
            <%= select_tag 'filter[tracker_id][]', 
                options_for_select([['ã™ã¹ã¦', '']] + project.rolled_up_trackers.map { |tracker| [tracker.name, tracker.id] }, 
                params[:filter] && params[:filter][:tracker_id] ? params[:filter][:tracker_id] : []),
                { multiple: true, class: 'filter-select filter-multi-select' } %>
          </div>
        </div>
        
        <div class="filter-row">
          <div class="filter-field">
            <%= label_tag 'filter[category_id][]', l(:field_category) %>
            <%= select_tag 'filter[category_id][]', 
                options_for_select([['ã™ã¹ã¦', '']] + project.issue_categories.map { |category| [category.name, category.id] }, 
                params[:filter] && params[:filter][:category_id] ? params[:filter][:category_id] : []),
                { multiple: true, class: 'filter-select filter-multi-select' } %>
          </div>
          
          <div class="filter-field">
            <%= label_tag 'filter[fixed_version_id][]', l(:field_version) %>
            <%= select_tag 'filter[fixed_version_id][]', 
                options_for_select([['ã™ã¹ã¦', '']] + project.shared_versions.map { |version| [version.name, version.id] }, 
                params[:filter] && params[:filter][:fixed_version_id] ? params[:filter][:fixed_version_id] : []),
                { multiple: true, class: 'filter-select filter-multi-select' } %>
          </div>
        </div>
      </div>
      
      <div class="filter-actions">
        <button type="button" class="icon icon-apply-filter" onclick="applyRedmineIssueFilter()">
          <span class="icon-text">ğŸ”</span>
          <%= l(:button_apply_filter, :scope => [:redmine_issue_summary_filter]) %>
        </button>
        
        <button type="button" class="icon icon-clear-filter" onclick="clearRedmineIssueFilter()">
          <span class="icon-text">ğŸ—‘ï¸</span>
          <%= l(:button_clear_filter, :scope => [:redmine_issue_summary_filter]) %>
        </button>
        
        <button type="button" class="icon icon-reset-filter" onclick="resetRedmineIssueFilter()">
          <span class="icon-text">ğŸ”„</span>
          ãƒªã‚»ãƒƒãƒˆ
        </button>
        
        <button type="button" class="icon icon-save-filter" onclick="saveRedmineIssueFilter()">
          <span class="icon-text">ğŸ’¾</span>
          ä¿å­˜
        </button>
        
        <button type="button" class="icon icon-load-filter" onclick="loadRedmineIssueFilter()">
          <span class="icon-text">ğŸ“</span>
          èª­ã¿è¾¼ã¿
        </button>
      </div>
    </div>
  <% end %>
</div>

<script>
function applyRedmineIssueFilter() {
  const form = document.getElementById('redmine-issue-filter-form');
  if (!form) return;
  
  const formData = new FormData(form);
  const params = new URLSearchParams();
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åé›†ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œï¼‰
  for (let [key, value] of formData.entries()) {
    if (value && value !== '') {
      params.append(key, value);
    }
  }
  
  // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
  window.location.href = form.action + '?' + params.toString();
}

function clearRedmineIssueFilter() {
  // ã™ã¹ã¦ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
  const selects = document.querySelectorAll('.filter-multi-select');
  selects.forEach(select => {
    select.selectedIndex = -1;
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ï¼ˆç©ºã®çŠ¶æ…‹ã§ï¼‰
  applyRedmineIssueFilter();
}

function resetRedmineIssueFilter() {
  // ã™ã¹ã¦ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
  const selects = document.querySelectorAll('.filter-multi-select');
  selects.forEach(select => {
    select.selectedIndex = 0; // æœ€åˆã®ã€Œã™ã¹ã¦ã€ã‚’é¸æŠ
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
  applyRedmineIssueFilter();
}

function saveRedmineIssueFilter() {
  const filterData = {};
  const selects = document.querySelectorAll('.filter-multi-select');
  
  selects.forEach(select => {
    const fieldName = select.name.replace('filter[', '').replace('][]', '');
    const selectedValues = Array.from(select.selectedOptions).map(option => option.value).filter(v => v !== '');
    if (selectedValues.length > 0) {
      filterData[fieldName] = selectedValues;
    }
  });
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
  localStorage.setItem('redmine_issue_filter_' + '<%= project.id %>', JSON.stringify(filterData));
  
  // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function loadRedmineIssueFilter() {
  const savedData = localStorage.getItem('redmine_issue_filter_' + '<%= project.id %>');
  if (!savedData) {
    alert('ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  try {
    const filterData = JSON.parse(savedData);
    const selects = document.querySelectorAll('.filter-multi-select');
    
    selects.forEach(select => {
      const fieldName = select.name.replace('filter[', '').replace('][]', '');
      if (filterData[fieldName]) {
        // ä¿å­˜ã•ã‚ŒãŸå€¤ã‚’é¸æŠ
        Array.from(select.options).forEach(option => {
          option.selected = filterData[fieldName].includes(option.value);
        });
      }
    });
    
    alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  } catch (e) {
    alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}
</script>